// Single file converter logic
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', handleFileSelect);

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFileSelect(e);
    });

    // Show JSON input option
    setTimeout(() => {
        document.querySelector('.json-input').style.display = 'block';
    }, 1000);
});

function handleFileSelect(event) {
    const files = event.target?.files || event.dataTransfer?.files;
    if (!files || files.length === 0) return;

    const file = files[0];
    
    // Show file info
    document.getElementById('fileInfo').innerHTML = `
        <strong>Selected File:</strong> ${file.name}<br>
        <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
        <strong>Type:</strong> ${file.type || 'Unknown'}
    `;
    document.getElementById('fileInfo').style.display = 'block';

    // Read file
    const reader = new FileReader();
    reader.onload = function(e) {
        if (file.name.endsWith('.json')) {
            convertJson(e.target.result, file.name);
        } else if (file.name.endsWith('.zip')) {
            window.converter.showNotification('Please extract ZIP and upload JSON files individually', 'info');
        } else {
            window.converter.showNotification('Please upload .json files only', 'error');
        }
    };
    
    reader.readAsText(file);
}

function convertJson(jsonText, fileName) {
    try {
        const data = JSON.parse(jsonText);
        const markdown = convertToMarkdown(data);
        document.getElementById('markdownOutput').value = markdown;
        document.querySelector('.markdown-output').style.display = 'block';
        document.getElementById('markdownOutput').focus();
        window.converter.showNotification(`${fileName} converted successfully!`, 'success');
    } catch (error) {
        window.converter.showNotification(`Error converting ${fileName}: ${error.message}`, 'error');
    }
}

function convertToMarkdown(data) {
    const meta = data.meta || {};
    const textMap = meta.text_map || {};
    
    let markdown = '';
    for (const [key, delta] of Object.entries(textMap)) {
        markdown += window.converter.parseDelta(delta) + '\n\n';
    }
    
    // If no textMap found, try blocks
    if (!markdown.trim()) {
        const blocks = data.blocks || {};
        for (const [key, block] of Object.entries(blocks)) {
            if (block.data) {
                markdown += `[Block: ${block.ty || 'unknown'}]\n`;
                if (typeof block.data === 'object') {
                    markdown += JSON.stringify(block.data, null, 2) + '\n';
                }
                markdown += '\n';
            }
        }
    }
    
    return markdown.trim();
}

function convertFromText() {
    const jsonText = document.getElementById('jsonInput').value;
    if (!jsonText.trim()) {
        window.converter.showNotification('Please enter JSON text', 'error');
        return;
    }
    convertJson(jsonText, 'pasted_json');
}

function copyMarkdown() {
    const output = document.getElementById('markdownOutput');
    if (!output.value.trim()) {
        window.converter.showNotification('No markdown to copy', 'error');
        return;
    }
    
    output.select();
    document.execCommand('copy');
    window.converter.showNotification('Markdown copied to clipboard!', 'success');
}

function downloadMarkdown() {
    const markdown = document.getElementById('markdownOutput').value;
    if (!markdown.trim()) {
        window.converter.showNotification('No markdown to download', 'error');
        return;
    }

    const fileName = prompt('Enter file name:', 'appflowy_converted.md') || 'appflowy_converted.md';
    
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName.endsWith('.md') ? fileName : fileName + '.md';
    a.click();
    URL.revokeObjectURL(url);
}

function clearAll() {
    document.getElementById('jsonInput').value = '';
    document.getElementById('markdownOutput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.querySelector('.markdown-output').style.display = 'none';
    window.converter.showNotification('Cleared all content', 'info');
}
